var dt=Object.defineProperty,gt=Object.defineProperties;var St=Object.getOwnPropertyDescriptors;var Ne=Object.getOwnPropertySymbols;var et=Object.prototype.hasOwnProperty,tt=Object.prototype.propertyIsEnumerable;var nt=n=>{throw TypeError(n)};var ke=(n,e,t)=>e in n?dt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,D=(n,e)=>{for(var t in e||(e={}))et.call(e,t)&&ke(n,t,e[t]);if(Ne)for(var t of Ne(e))tt.call(e,t)&&ke(n,t,e[t]);return n},rt=(n,e)=>gt(n,St(e));var Ee=(n,e)=>{var t={};for(var r in n)et.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&Ne)for(var r of Ne(n))e.indexOf(r)<0&&tt.call(n,r)&&(t[r]=n[r]);return t};var G=(n,e,t)=>ke(n,typeof e!="symbol"?e+"":e,t),Fe=(n,e,t)=>e.has(n)||nt("Cannot "+t);var l=(n,e,t)=>(Fe(n,e,"read from private field"),t?t.call(n):e.get(n)),f=(n,e,t)=>e.has(n)?nt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),d=(n,e,t,r)=>(Fe(n,e,"write to private field"),r?r.call(n,t):e.set(n,t),t),A=(n,e,t)=>(Fe(n,e,"access private method"),t);var ye=(n,e,t,r)=>({set _(s){d(n,e,s,t)},get _(){return l(n,e,r)}});var k=(n,e,t)=>new Promise((r,s)=>{var i=a=>{try{p(t.next(a))}catch(c){s(c)}},o=a=>{try{p(t.throw(a))}catch(c){s(c)}},p=a=>a.done?r(a.value):Promise.resolve(a.value).then(i,o);p((t=t.apply(n,e)).next())});import wt from"mithril";import F from"mithril";import Ve from"mithril";function st({style:n,datatype:e,type:t,firstPickComponent:r,typeDefs:s,fallbackComponent:i}){var o,p,a;if(typeof r!="undefined")return r;if(typeof e!="undefined"&&typeof((o=s[e])==null?void 0:o[n])!="undefined")return s[e][n];if(typeof t=="string"&&typeof((p=s[t])==null?void 0:p[n])!="undefined")return s[t][n];if(Array.isArray(t)){for(let c of t)if(typeof((a=s[c])==null?void 0:a[n])!="undefined")return s[c][n]}if(typeof i!="undefined")return i}function W(n,e,t){let r,s={},i;return typeof n=="string"?r=n:typeof n=="function"?i=n:n!=null&&(s=n),typeof e=="function"?i=e:e!=null&&(s=e),typeof t=="function"&&(i=t),i==null&&(i=o=>o.present(s)),[r,s,i]}function h(n){return typeof n=="object"&&!Array.isArray(n)&&n!==null}function it(n){if(h(n)){if(typeof n["@type"]=="string")return!0;if(!Array.isArray(n["@type"]))return!1}else return!1;for(let e of n["@type"])if(typeof e!="string")return!1;return!0}function ot(n){if(it(n))return n["@type"]}function $e(n,e){let t=Object.assign({},e),r=ot(n.value),s={isOctiron:!0,octironType:"selection",value:n.value},i=Object.assign((o,p)=>n.parent==null?null:o(n.parent)?p:null,{isOctiron:!0,octironType:"selection",readonly:!0,id:n.datatype,get value(){return s.value},get store(){return n.store},not:(o,p)=>n.parent==null||o(n.parent)?null:p,root:(o,p,a)=>{let c,[u,m,g]=W(o,p,a);return u==null?c=n.store.rootIRI:c=`${n.store.rootIRI} ${u}`,Ve(U,{selector:c,args:m,view:g,internals:{store:n.store,typeDefs:n.typeDefs}})},enter(o,p,a){let[c,u,m]=W(o,p,a);return Ve(U,{selector:c,args:u,view:m,internals:{store:n.store,typeDefs:n.typeDefs}})},select:(o,p,a)=>{let[c,u,m]=W(o,p,a);return h(n.value)?Ve(U,{selector:c,args:u,view:m,internals:{store:n.store,typeDefs:n.typeDefs,value:n.value}}):null},present(o){var b;let p={},a,c;(o==null?void 0:o.attrs)!=null?p=o.attrs:(t==null?void 0:t.attrs)!=null&&(p=t.attrs),(o==null?void 0:o.component)!=null?a=o.component:(t==null?void 0:t.component)!=null&&(a=t.component),(o==null?void 0:o.fallbackComponent)!=null?c=o.fallbackComponent:(t==null?void 0:t.fallbackComponent)!=null&&(c=t.fallbackComponent);let u=st({style:"present",datatype:n.datatype,type:r,firstPickComponent:a,fallbackComponent:c,typeDefs:(b=n.typeDefs)!=null?b:{}});if(u==null)return null;let{pre:m,sep:g,post:S,start:y,end:T,predicate:w}=Object.assign({},t,o);return Ve(u,{o:i,renderType:"present",value:i.value,attrs:p,pre:m,sep:g,post:S,start:y,end:T,predicate:w})},_updateArgs:o=>{for(let[p,a]of Object.entries(o))t[p]=a},_updateValue:o=>{s.value=o}});return i}import ht from"mithril";var E=typeof window!="undefined";function z(){E&&ht.redraw()}function Ot(n,e){return n.internals.store!==e.internals.store||n.selector!==e.selector||n.internals.value!==e.internals.value}var U=n=>{let e=Symbol("SelectionRenderer"),t=n.attrs,r,s={};function i(){let c=!1,{store:u,typeDefs:m}=t.internals,g=[];if(r==null){let y=Reflect.ownKeys(s);for(let T of y)g.includes(T)||(c=!0,delete s[T]);c&&z();return}for(let y of r.result){if(g.push(y.key),Object.hasOwn(s,y.key)){let w=y,b=s[y.key].selectionResult;if(b.type==="value"&&w.type==="value"&&w.value===b.value)continue;if(b.type==="entity"&&w.type==="entity"&&(w.ok!==b.ok||w.status!==b.status||w.value!==b.value))continue}c=!0;let T;y.type==="entity"?T=$e({store:u,typeDefs:m,value:y.value}):T=$e({store:u,typeDefs:m,value:y.value,datatype:y.datatype}),s[y.key]={octiron:T,selectionResult:y}}let S=Reflect.ownKeys(s);for(let y of S)g.includes(y)||(c=!0,delete s[y]);c&&z()}function o(c){return k(this,null,function*(){if(c.length===0)return;let u=[];for(let m of c)u.push(t.internals.store.fetch(m));yield Promise.allSettled(u)})}function p(c){let u=[];if(typeof r=="undefined")u=c.required;else for(let m of c.required)r.required.includes(m)||u.push(m);r=c,u.length>0&&o(u),i()}function a(){if(typeof t.internals.value!="undefined"&&!h(t.internals.value)){t.internals.store.unsubscribe(e),i();return}r=t.internals.store.subscribe({key:e,selector:t.selector,value:t.internals.value,listener:p}),o(r.required),i()}return{oninit:({attrs:c})=>{t=c,a()},onbeforeupdate:({attrs:c})=>{let u=Ot(c,t);t=c,u&&(c.internals.store.unsubscribe(e),a())},onbeforeremove:({attrs:c})=>{t=c,c.internals.store.unsubscribe(e)},view:({attrs:c})=>{if(r==null||!r.complete)return c.args.loading;if((r.hasErrors||r.hasMissing)&&typeof c.args.fallback!="function")return c.args.fallback;let u=t.view,{pre:m,sep:g,post:S,start:y,end:T,predicate:w,fallback:b}=t.args;if(typeof u=="undefined")return;let V=[],K=Reflect.ownKeys(s).map(J=>s[J]);(y!=null||T!=null)&&(K=K.slice(y!=null?y:0,T)),w!=null&&(K=K.filter(({octiron:J})=>w(J))),m!=null&&V.push(F.fragment({key:bt},[m]));for(let J=0;J<K.length;J++){let{selectionResult:fe,octiron:De}=K[J],{key:me}=fe;J!==0&&V.push(F.fragment({key:`@${Symbol.keyFor(me)}`},[g])),fe.type==="value"?V.push(F.fragment({key:me},[u(De)])):!fe.ok&&typeof b=="function"?V.push(F.fragment({key:me},[b(De,fe.reason)])):fe.ok?V.push(F.fragment({key:me},[u(De)])):V.push(F.fragment({key:me},[b]))}return S!=null&&V.push(F.fragment({key:Tt},[S])),V}}},bt=Symbol.for("@pre"),Tt=Symbol.for("@post");function Be(n){let e=Object.assign((t,r)=>e.root(s=>s(t,r)),{octironType:"root",isOctiron:!0,readonly:!0,value:null,store:n.store,not(t,r){return e.root(s=>s.not(t,r))},root(t,r,s){let i,[o,p,a]=W(t,r,s);return o==null?i=n.store.rootIRI:i=`${n.store.rootIRI} ${o}`,wt(U,{selector:i,args:p,view:a,internals:{store:n.store,typeDefs:n.typeDefs}})},select(t,r,s){return e.root(t,r,s)},present(t,r){return e.root(t,r)}});return e}function qe(...n){let e={};for(let t of n)e[t.type]=t;return e}import lt from"mithril";var Rt=()=>({view({attrs:{fragment:n,rootHTML:e,fragmentsHTML:t}}){let r=n==null?e:t[n];return r==null?null:lt.trust(r)}}),Je,Le,C,Ke,H,L,Q,X,de,xe=class xe{constructor(e,{iri:t,contentType:r,root:s,ided:i,anon:o}){G(this,"integrationType","html-fragments");f(this,Je);f(this,Le,new Set);f(this,C);f(this,Ke);f(this,H);f(this,L);f(this,Q);f(this,X);f(this,de);d(this,Je,e),d(this,C,t),d(this,H,r),d(this,L,s),d(this,Q,i!=null?i:{}),d(this,X,o!=null?o:{}),d(this,de,D(D({},o),i))}get iri(){return l(this,C)}get contentType(){return l(this,H)}render(e){return lt(Rt,{o:e,rootHTML:l(this,L),fragmentsHTML:l(this,de)})}getStateInfo(){return{iri:l(this,C),contentType:l(this,H),hasRoot:l(this,L)!=null,ided:Object.keys(l(this,Q)),anon:Object.keys(l(this,X))}}toInitialState(){let e="";l(this,L)!=null&&(e+=`<template id="htmlfrag:${l(this,C)}|${l(this,H)}">${l(this,L)}</template>
`);for(let[t,r]of Object.entries(l(this,Q)))l(this,Le).has(t)||(e+=`<template id="htmlfrag:${l(this,C)}|${l(this,H)}|${t}">${r}</template>
`);for(let[t,r]of Object.entries(l(this,X)))e+=`<template id="htmlfrag:${l(this,C)}#${t}|${l(this,H)}">${r}</template>
`;return e}static fromInitialState(e,{iri:t,contentType:r,hasRoot:s,ided:i,anon:o}){let p,a={},c={};if(s){let u=document.getElementById(`htmlfrag:${t}|${r}`);u&&(p=u.outerHTML)}for(let u of i){let m=document.getElementById(u);if(m instanceof HTMLTemplateElement){let g=m.cloneNode(!0);a[u]=g.innerHTML}else a[u]=m.innerHTML}for(let u of o){let m=document.getElementById(`htmlfrag:${t}#${u}|${r}`);if(m instanceof HTMLTemplateElement){let g=m.cloneNode(!0);a[u]=g.innerHTML}else a[u]=m.innerHTML}return new xe(e,{contentType:r,iri:t,root:p,ided:a,anon:c})}};Je=new WeakMap,Le=new WeakMap,C=new WeakMap,Ke=new WeakMap,H=new WeakMap,L=new WeakMap,Q=new WeakMap,X=new WeakMap,de=new WeakMap,G(xe,"type","html-fragments");var Y=xe;import ct from"mithril";var It=()=>{let n;return{oncreate({dom:e,attrs:{o:t,el:r,handler:s}}){r!=null&&e.append(r),s.onCreate!=null&&(n=s.onCreate({o:t,dom:e,addFragmentListener:()=>{}}))},onbeforeremove(){n!=null&&n()},view({attrs:{html:e,el:t}}){return t!=null?null:ct.trust(e)}}},Se,Z,$,B,_,ee,he,ge=class ge{constructor(e,{iri:t,contentType:r,html:s,id:i,el:o}){G(this,"integrationType","html");f(this,Se);f(this,Z,!1);f(this,$);f(this,B);f(this,_);f(this,ee);f(this,he);d(this,Se,e),d(this,$,t),d(this,B,r),d(this,_,s),d(this,ee,i),d(this,he,o)}get iri(){return l(this,$)}get contentType(){return l(this,B)}render(e){return!E&&!l(this,Z)&&d(this,Z,!0),ct(It,{o:e,html:l(this,_),el:l(this,he),handler:l(this,Se)})}getStateInfo(){return{iri:l(this,$),contentType:l(this,B),id:l(this,ee)}}toInitialState(){return l(this,ee)!=null&&l(this,Z)?"":`<template id="html:${l(this,$)}|${l(this,B)}">${l(this,_)}</template>
`}static fromInitialState(e,{iri:t,contentType:r,id:s}){let i=null;return s!=null&&(i=document.getElementById(s)),i!=null?new ge(e,{iri:t,contentType:r,html:i.outerHTML,id:s,el:i}):(i=document.getElementById(`html:${t}|${r}`),i instanceof HTMLTemplateElement?(i=i.cloneNode(!0),new ge(e,{iri:t,contentType:r,html:i.outerHTML,id:s,el:i})):null)}};Se=new WeakMap,Z=new WeakMap,$=new WeakMap,B=new WeakMap,_=new WeakMap,ee=new WeakMap,he=new WeakMap,G(ge,"type","html");var te=ge;var ne,Oe,ve=class{constructor(e,t){f(this,ne);f(this,Oe);d(this,ne,e),d(this,Oe,t)}get status(){return l(this,ne)}get res(){return l(this,Oe)}undefined(){return null}http(e){return typeof e=="function"?e(l(this,ne)):e}unparserable(){return null}};ne=new WeakMap,Oe=new WeakMap;function re(n){return Array.isArray(n)?n:Array.isArray(n["@list"])?n["@list"]:Array.isArray(n["@set"])?n["@set"]:[]}function M(n){return h(n)&&typeof n["@id"]=="string"&&n["@id"]!==""}function se(n){if(Array.isArray(n))return!0;if(h(n)){if(Array.isArray(n["@list"]))return!0;if(Array.isArray(n["@set"]))return!0}return!1}function x(n){let e=Object.keys(n);if(e.length===0)return!1;for(let t of e)if(!t.startsWith("@")||t==="@value"||t==="@list"||t==="@set")return!1;return!0}function be(n){return typeof n["@value"]!="undefined"}function ie(n,e=[]){if(Array.isArray(n))for(let t of n)ie(t,e);else if(h(n)){if(x(n))return e;if(M(n)&&e.push(n),be(n))ie(n["@value"],e);else if(se(n))ie(re(n),e);else for(let[t,r]of Object.entries(n))t.startsWith("@")||ie(r,e)}return e}function at(...n){return`${n.map(t=>t.replace(/~/,"~0").replace(/\//,"~1")).join("/")}`}var jt=new RegExp("\\s*(?<subject>([^\\[\\s]+))(\\[(?<filter>([^\\]])+)\\])?\\s*","g");function Ge(n){var r,s;let e,t=[];for(;e=jt.exec(n);){let i=(r=e.groups)==null?void 0:r.subject,o=(s=e.groups)==null?void 0:s.filter;if(typeof o=="string"&&typeof i=="string")t.push({subject:i,filter:o});else if(typeof i=="string")t.push({subject:i});else throw new Error(`Invalid selector: ${n}`)}return t}var We=class extends Error{};function pt(n){for(let e=0;e<n.result.length;e++){let t=n.result[e];t.key=Symbol.for(t.keySource),delete t.keySource}return n}function Pe({selector:n,value:e,actionValue:t,store:r}){let s={complete:!1,hasErrors:!1,hasMissing:!1,required:[],dependencies:[],result:[]};if(typeof e=="undefined"){let[{subject:o,filter:p},...a]=Ge(n);return we({keySource:"",pointer:"",iri:o,filter:p,selector:a.length>0?a:void 0,store:r,details:s}),s.complete=s.required.length===0,pt(s)}let i=Ge(n);Te({keySource:"",pointer:"",value:e,actionValue:t,selector:i,store:r,details:s}),s.complete=s.required.length===0;for(let o=0;o<s.result.length;o++){let p=s.result[o];p.key=Symbol.for(p.keySource)}return pt(s)}function R(n,e){return`${n}/${at(e.toString())}`}function ze({value:n,filter:e}){return typeof e!="string"?!0:Array.isArray(n["@type"])?n["@type"].includes(e):n["@type"]===e}function Qe(n){return n!==null&&typeof n!="undefined"&&typeof n!="boolean"&&typeof n!="number"&&typeof n!="string"}function Ue({keySource:n,pointer:e,value:t,datatype:r,filter:s,store:i,details:o}){if(t==null){o.hasMissing=!0;return}if(Qe(t)){if(se(t)){let p=re(t);for(let a=0;a<p.length;a++){let c=p[a];if(M(c)||(n=R(n,a)),Ue({keySource:n,pointer:R(e,a),value:c,datatype:r,filter:s,store:i,details:o}),o.hasErrors||o.hasMissing)return}return}}else{o.result.push({keySource:e,pointer:e,type:"value",datatype:r,value:t});return}if(!(typeof s=="string"&&!ze({value:t,filter:s}))){if(be(t)){Ue({keySource:n,pointer:e,value:t["@value"],datatype:r,store:i,details:o});return}else if(x(t)){we({keySource:n,pointer:e,iri:t["@id"],filter:s,store:i,details:o});return}if(M(t)){let p=t["@id"];o.result.push({keySource:n,pointer:e,type:"entity",iri:p,ok:!0,value:t});return}o.result.push({keySource:n,pointer:e,type:"value",datatype:r,value:t})}}function ut({keySource:n,pointer:e,type:t,value:r,actionValue:s,filter:i,store:o,details:p}){if(e=R(e,t),!Qe(r))return;if(se(r)){let c=re(r);for(let u=0;u<c.length;u++){let m=c[u];if(M(m)||(n=R(n,u)),ut({keySource:n,pointer:R(e,u),type:t,value:m,actionValue:s,filter:i,store:o,details:p}),p.hasErrors||p.hasMissing)return}return}if(x(r)&&M(r)){we({keySource:n,pointer:e,iri:r["@id"],selector:[{subject:t,filter:i}],store:o,details:p});return}else if(x(r))return;let a;h(s==null?void 0:s[`${t}-input`])&&(a=s[`${t}-input`]),Ue({keySource:n,pointer:e,value:r[t],spec:a,actionValue:s==null?void 0:s[t],datatype:t,filter:i,store:o,details:p})}function Te({keySource:n,pointer:e,selector:t,value:r,actionValue:s,store:i,details:o}){if(t.length===0)return;if(!Qe(r))return;if(se(r)){let g=re(r);for(let S=0;S<g.length;S++){let y=g[S];if(M(y)||(n=R(n,S)),Te({keySource:n,pointer:R(e,S),selector:t,value:y,actionValue:s,store:i,details:o}),o.hasErrors||o.hasMissing)return}return}else be(r)&&Te({keySource:n,pointer:e,selector:t,value:r["@value"],actionValue:s,store:i,details:o});if(x(r)&&M(r)){we({keySource:n,pointer:e,selector:t,iri:r["@id"],store:i,details:o});return}h(r)&&s!==void 0&&r[t[0].subject]==null&&(r={[t[0].subject]:null});let[p,...a]=t,{subject:c,filter:u}=p;if(r[c]==null){o.hasMissing=!0;return}if(a.length===0){ut({keySource:n,pointer:e,type:c,filter:u,value:r,actionValue:s,store:i,details:o});return}if(typeof u=="string"&&!ze({value:r,filter:u}))return;let m;h(s==null?void 0:s[c])&&(m=s[c]),Te({keySource:R(n,c),pointer:R(e,c),selector:a,value:r[c],actionValue:m,store:i,details:o})}function we({keySource:n,pointer:e,iri:t,filter:r,selector:s,store:i,details:o,handledIRIs:p}){n=R(n,t),e=R(e,t);let a=i.entity(t);if(o.dependencies.push(t),typeof a=="undefined"||a.loading){o.required.includes(t)||o.required.push(t);return}if(!a.ok){if(o.hasErrors=!0,typeof s=="undefined"||s.length===0)return;o.result.push({keySource:n,pointer:e,type:"entity",iri:a.iri,ok:!1,status:a.status,value:a.value,reason:a.reason});return}let c=a.value;if(x(c)){if(p==null)p=new Set([c["@id"]]);else if(!p.has(c["@id"]))p.add(c["@id"]);else throw new We("Circular selection loop detected");return we({keySource:n,pointer:e,iri:c["@id"],filter:r,selector:s,details:o,store:i,handledIRIs:p})}if(!(typeof r=="string"&&!ze({filter:r,value:c}))){if(typeof s=="undefined"){o.result.push({keySource:n,pointer:e,type:"entity",iri:a.iri,ok:!0,value:a.value});return}Te({keySource:n,pointer:e,value:c,selector:s,store:i,details:o})}}var oe="application/problem+json, application/ld+json, text/lf",At={[te.type]:te,[Y.type]:Y};function Ct(n,e){let t=new Map,r={};if(n!=null&&(r["@vocab"]=n),e==null)return[t,r];for(let[s,i]of Object.entries(e))r[s]=i,t.set(`^${s}:`,i);return[t,r]}function Ht(n,e){let t=new Headers([["accept",oe]]),r=new Map;if(n!=null)for(let[s,i]of Object.entries(n))t.set(s,i);if(e!=null)for(let[s,i]of Object.entries(e)){let o=new Headers([["accept",oe]]);for(let[p,a]of Object.entries(i))o.set(p,a);r.set(s,o)}return[t,r]}var le,Ie,N,ce,v,ae,I,pe,P,je,Ae,Ce,He,Me,ue,j,q,O,Xe,Ye,Ze,ft,mt,_e=class _e{constructor(e){f(this,O);f(this,le);f(this,Ie);f(this,N);f(this,ce);f(this,v);f(this,ae);f(this,I,new Map);f(this,pe,new Set);f(this,P,new Map);f(this,je);f(this,Ae,new Set);f(this,Ce);f(this,He,new Map);f(this,Me);f(this,ue);f(this,j,new Map);f(this,q,new Map);var t;d(this,le,e.rootIRI),d(this,Ie,new URL(e.rootIRI).origin),d(this,v,e.vocab),d(this,Me,(t=e.fetcher)!=null?t:fetch),d(this,ue,e.responseHook),[ye(this,N)._,ye(this,ce)._]=Ht(e.headers,e.origins),[ye(this,ae)._,ye(this,Ce)._]=Ct(e.vocab,e.aliases),d(this,je,new Map(e.handlers.map(r=>[r.contentType,r]))),e.primary!=null&&d(this,I,new Map(Object.entries(e.primary))),l(this,N).has("accept")||l(this,N).set("accept",oe);for(let r of Object.values(l(this,ce)))r.has("accept")||r.set("accept",oe)}get rootIRI(){return l(this,le)}entity(e){return l(this,I).get(e)}get context(){return l(this,Ce)}expand(e){let t=Symbol.for(e),r=l(this,He).get(t);if(r!=null)return r;let s;if(l(this,v)!=null&&e.startsWith(l(this,v)))s=e.replace(l(this,v),"");else if(/https?:\/\//.test(e))s=e;else for(let[i,o]of l(this,ae)){let p=new RegExp(i);if(p.test(e)){s=e.replace(p,o);break}}return l(this,He).set(t,s!=null?s:e),s!=null?s:e}select(e,t){return Pe({selector:e,value:t,store:this})}key(){if(E)return"";for(;;){let e=Math.random().toString(36).slice(2,7);if(!l(this,Ae).has(e))return l(this,Ae).add(e),e}}isLoading(e){let t=A(this,O,Ye).call(this,e,"get");return l(this,pe).has(t)}handleResponse(e){return k(this,null,function*(){var i,o,p;let t=e.url.toString(),r=(p=(o=(i=e.headers.get("content-type"))==null?void 0:i.split)==null?void 0:o.call(i,";"))==null?void 0:p[0];if(r==null)throw new Error("Content type not specified in response");let s=l(this,je).get(r);if(s==null)throw new Error(`No handler configured for content type "${r}"`);if(s.integrationType==="jsonld"){let a=yield s.handler({res:e,store:this});A(this,O,ft).call(this,{iri:t,res:e,output:a})}else{if(s.integrationType==="problem-details")throw new Error("Problem details response types not supported yet");if(s.integrationType==="html"){let a=yield s.handler({res:e,store:this}),c=l(this,P).get(r);c==null&&(c=new Map,l(this,P).set(r,c)),c.set(t,new te(s,{iri:t,contentType:r,html:a.html,id:a.id}))}else if(s.integrationType==="html-fragments"){let a=yield s.handler({res:e,store:this}),c=l(this,P).get(r);c==null&&(c=new Map,l(this,P).set(r,c)),c.set(t,new Y(s,{iri:t,contentType:r,root:a.html,ided:a.ided,anon:a.anon}))}}s.integrationType!=="jsonld"&&A(this,O,Ze).call(this,t,r)})}subscribe({key:e,selector:t,value:r,listener:s}){let i=Pe({selector:t,value:r,store:this}),o=A(this,O,Xe).call(this,e,i);for(let p of i.dependencies){let a=l(this,j).get(p);a==null?l(this,j).set(p,new Set([e])):a.add(e)}return l(this,q).set(e,{key:e,selector:t,value:r,required:i.required,dependencies:i.dependencies,listener:s,cleanup:o}),i}unsubscribe(e){var t;(t=l(this,q).get(e))==null||t.cleanup()}fetch(e){return k(this,null,function*(){return yield A(this,O,mt).call(this,e),l(this,I).get(e)})}static fromInitialState({headers:e,origins:t,handlers:r=[]}){let s=document.getElementById("oct-state-info"),i=JSON.parse(s.innerText),o=new Map,p=r.reduce((a,c)=>rt(D({},a),{[c.contentType]:c}),{});for(let[a,c]of Object.entries(i.alternatives))for(let u of c){let m=p[u.contentType],g=At[a];if(g.type!==m.integrationType)continue;let S=g.fromInitialState(m,u);if(S==null)continue;let y=o.get(S.contentType);y==null&&(y=new Map,o.set(S.contentType,y)),y.set(S.iri,S)}return new _e({handlers:r,alternatives:o,headers:e,origins:t,rootIRI:i.rootIRI,vocab:i.vocab,aliases:i.aliases,primary:i.primary})}toInitialState(){let e="",t={rootIRI:l(this,le),vocab:l(this,v),aliases:Object.fromEntries(l(this,ae)),primary:Object.fromEntries(l(this,I)),alternatives:{}};for(let r of l(this,P).values())for(let s of r.values())t.alternatives[s.integrationType]==null?t.alternatives[s.integrationType]=[s.getStateInfo()]:t.alternatives[s.integrationType].push(s.getStateInfo()),e+=s.toInitialState();return e+=`<script id="oct-state-info" type="application/json">${JSON.stringify(t)}<\/script>`,e}};le=new WeakMap,Ie=new WeakMap,N=new WeakMap,ce=new WeakMap,v=new WeakMap,ae=new WeakMap,I=new WeakMap,pe=new WeakMap,P=new WeakMap,je=new WeakMap,Ae=new WeakMap,Ce=new WeakMap,He=new WeakMap,Me=new WeakMap,ue=new WeakMap,j=new WeakMap,q=new WeakMap,O=new WeakSet,Xe=function(e,t){return()=>{l(this,q).delete(e);for(let r of t.dependencies)l(this,j).delete(r),E&&setTimeout(()=>{var s;((s=l(this,j).get(r))==null?void 0:s.size)===0&&l(this,I).delete(r)},5e3)}},Ye=function(e,t,r){return r=r||l(this,N).get("accept")||oe,`${t==null?void 0:t.toLowerCase()}|${e}|${r.toLowerCase()}`},Ze=function(e,t){let r=l(this,j).get(e);if(r!=null)for(let s of r){let i=l(this,q).get(s);if(i==null)continue;let o=Pe({selector:i.selector,value:i.value,store:this}),p=A(this,O,Xe).call(this,s,o);for(let a of o.dependencies){let c=l(this,j).get(a);c==null?(c=new Set([s]),l(this,j).set(a,c)):c.add(s)}i.cleanup=p,i.listener(o)}},ft=function({iri:e,res:t,output:r}){let s=[e];if(t.ok)l(this,I).set(e,{iri:e,loading:!1,ok:!0,value:r.jsonld});else{let i=new ve(t.status,t);l(this,I).set(e,{iri:e,loading:!1,ok:!1,value:r.jsonld,status:t.status,reason:i})}for(let i of ie(r.jsonld))s.includes(i["@id"])||l(this,I).set(i["@id"],{iri:i["@id"],loading:!1,ok:!0,value:i});for(let i in s)A(this,O,Ze).call(this,i)},mt=function(r){return k(this,arguments,function*(e,t={}){let s=new URL(e),i=t.method||"get",o=t.accept||l(this,N).get("accept")||oe,p=A(this,O,Ye).call(this,e,i,t.accept),a=new Headers(l(this,N));if(a.set("accept",o),s.origin!==l(this,Ie)&&!l(this,ce).has(s.origin))throw new Error("Unconfigured origin");l(this,pe).add(p),z();let c=new Promise(u=>{k(this,null,function*(){let m=yield l(this,Me).call(this,e,{method:i,headers:a,body:t.body});yield this.handleResponse(m),l(this,pe).delete(p),z(),u(m)})});l(this,ue)!=null&&l(this,ue).call(this,c),yield c})};var Re=_e;function Qn(n){return n}function yt(t){var r=t,{typeDefs:n}=r,e=Ee(r,["typeDefs"]);let s=n!=null?qe(...n):{},i=new Re(e);return Be({store:i,typeDefs:s})}yt.fromInitialState=t=>{var r=t,{typeDefs:n}=r,e=Ee(r,["typeDefs"]);let s=n!=null?qe(...n):{},i=Re.fromInitialState(D({},e));return Be({store:i,typeDefs:s})};export{Re as Store,yt as default,Qn as makeTypeDef,qe as makeTypeDefs};
