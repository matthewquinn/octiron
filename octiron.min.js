var gt=Object.defineProperty,ht=Object.defineProperties;var St=Object.getOwnPropertyDescriptors;var Ne=Object.getOwnPropertySymbols;var et=Object.prototype.hasOwnProperty,tt=Object.prototype.propertyIsEnumerable;var nt=n=>{throw TypeError(n)};var Ee=(n,e,t)=>e in n?gt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,k=(n,e)=>{for(var t in e||(e={}))et.call(e,t)&&Ee(n,t,e[t]);if(Ne)for(var t of Ne(e))tt.call(e,t)&&Ee(n,t,e[t]);return n},rt=(n,e)=>ht(n,St(e));var ke=(n,e)=>{var t={};for(var s in n)et.call(n,s)&&e.indexOf(s)<0&&(t[s]=n[s]);if(n!=null&&Ne)for(var s of Ne(n))e.indexOf(s)<0&&tt.call(n,s)&&(t[s]=n[s]);return t};var W=(n,e,t)=>Ee(n,typeof e!="symbol"?e+"":e,t),Fe=(n,e,t)=>e.has(n)||nt("Cannot "+t);var l=(n,e,t)=>(Fe(n,e,"read from private field"),t?t.call(n):e.get(n)),m=(n,e,t)=>e.has(n)?nt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),d=(n,e,t,s)=>(Fe(n,e,"write to private field"),s?s.call(n,t):e.set(n,t),t),C=(n,e,t)=>(Fe(n,e,"access private method"),t);var de=(n,e,t,s)=>({set _(r){d(n,e,r,t)},get _(){return l(n,e,s)}});var A=(n,e,t)=>new Promise((s,r)=>{var o=a=>{try{p(t.next(a))}catch(c){r(c)}},i=a=>{try{p(t.throw(a))}catch(c){r(c)}},p=a=>a.done?s(a.value):Promise.resolve(a.value).then(o,i);p((t=t.apply(n,e)).next())});import Rt from"mithril";import $ from"mithril";import Je from"mithril";function st({style:n,datatype:e,type:t,firstPickComponent:s,typeDefs:r,fallbackComponent:o}){var i,p,a;if(typeof s!="undefined")return s;if(typeof e!="undefined"&&typeof((i=r[e])==null?void 0:i[n])!="undefined")return r[e][n];if(typeof t=="string"&&typeof((p=r[t])==null?void 0:p[n])!="undefined")return r[t][n];if(Array.isArray(t)){for(let c of t)if(typeof((a=r[c])==null?void 0:a[n])!="undefined")return r[c][n]}if(typeof o!="undefined")return o}function z(n,e,t){let s,r={},o;return typeof n=="string"?s=n:typeof n=="function"?o=n:n!=null&&(r=n),typeof e=="function"?o=e:e!=null&&(r=e),typeof t=="function"&&(o=t),o==null&&(o=i=>i.present(r)),[s,r,o]}function h(n){return typeof n=="object"&&!Array.isArray(n)&&n!==null}function ot(n){if(h(n)){if(typeof n["@type"]=="string")return!0;if(!Array.isArray(n["@type"]))return!1}else return!1;for(let e of n["@type"])if(typeof e!="string")return!1;return!0}function it(n){if(ot(n))return n["@type"]}function $e(n,e){let t=Object.assign({},e),s=it(n.value),r={isOctiron:!0,octironType:"selection",value:n.value},o=Object.assign((i,p)=>i(o)?p:null,{isOctiron:!0,octironType:"selection",readonly:!0,id:n.datatype,get value(){return r.value},get store(){return n.store},not:(i,p)=>i(o)?null:p,root:(i,p,a)=>{let c,[f,u,g]=z(i,p,a);return f==null?c=n.store.rootIRI:c=`${n.store.rootIRI} ${f}`,Je(Q,{selector:c,args:u,view:g,internals:{store:n.store,typeDefs:(u==null?void 0:u.typeDefs)||n.typeDefs,parent:o}})},enter(i,p,a){let[c,f,u]=z(i,p,a);return Je(Q,{selector:c,args:f,view:u,internals:{store:n.store,typeDefs:(f==null?void 0:f.typeDefs)||n.typeDefs,parent:o}})},select:(i,p,a)=>{let[c,f,u]=z(i,p,a);return h(n.value)?Je(Q,{selector:c,args:f,view:u,internals:{store:n.store,typeDefs:(f==null?void 0:f.typeDefs)||n.typeDefs,value:n.value,parent:o}}):null},present(i){let p={},a,c;(i==null?void 0:i.attrs)!=null?p=i.attrs:(t==null?void 0:t.attrs)!=null&&(p=t.attrs),(i==null?void 0:i.component)!=null?a=i.component:(t==null?void 0:t.component)!=null&&(a=t.component),(i==null?void 0:i.fallbackComponent)!=null?c=i.fallbackComponent:(t==null?void 0:t.fallbackComponent)!=null&&(c=t.fallbackComponent);let f=st({style:"present",datatype:n.datatype,type:s,firstPickComponent:a,fallbackComponent:c,typeDefs:(i==null?void 0:i.typeDefs)||n.typeDefs||{}});if(f==null)return null;let{pre:u,sep:g,post:y,start:O,end:S,predicate:R}=Object.assign({},t,i);return Je(f,{o,renderType:"present",value:o.value,attrs:p,pre:u,sep:g,post:y,start:O,end:S,predicate:R})},_updateArgs:i=>{for(let[p,a]of Object.entries(i))t[p]=a},_updateValue:i=>{r.value=i}});return o}import Ot from"mithril";var F=typeof window!="undefined";function X(){F&&Ot.redraw()}var bt=Symbol.for("@pre"),Tt=Symbol.for("@post");function wt(n,e){return n.internals.store!==e.internals.store||n.selector!==e.selector||n.internals.value!==e.internals.value}var Q=n=>{let e=Symbol("SelectionRenderer"),t=n.attrs,s,r={};function o(){let c=!1,{store:f,typeDefs:u,parent:g}=t.internals,y=[];if(s==null){let S=Reflect.ownKeys(r);for(let R of S)y.includes(R)||(c=!0,delete r[R]);c&&X();return}for(let S of s.result){let R=Symbol.for(S.pointer);if(y.push(R),Object.hasOwn(r,R)){let b=S,w=r[R].selectionResult;if(w.type==="value"&&b.type==="value"&&b.value===w.value)continue;if(w.type==="entity"&&b.type==="entity"&&(b.ok!==w.ok||b.status!==w.status||b.value!==w.value))continue}c=!0;let E;S.type==="entity"?E=$e({store:f,typeDefs:u,value:S.value,parent:g}):E=$e({store:f,typeDefs:u,value:S.value,datatype:S.datatype,parent:g}),r[R]={octiron:E,selectionResult:S}}let O=Reflect.ownKeys(r);for(let S of O)y.includes(S)||(c=!0,delete r[S]);c&&X()}function i(c){return A(this,null,function*(){if(c.length===0)return;let f=[];for(let u of c)f.push(t.internals.store.fetch(u));yield Promise.allSettled(f)})}function p(c){let f=[];if(typeof s=="undefined")f=c.required;else for(let u of c.required)s.required.includes(u)||f.push(u);s=c,f.length>0&&i(f),o()}function a(){if(typeof t.internals.value!="undefined"&&!h(t.internals.value)){t.internals.store.unsubscribe(e),o();return}s=t.internals.store.subscribe({key:e,selector:t.selector,value:t.internals.value,listener:p}),i(s.required),o()}return{oninit:({attrs:c})=>{t=c,a()},onbeforeupdate:({attrs:c})=>{let f=wt(c,t);t=c,f&&(c.internals.store.unsubscribe(e),a())},onbeforeremove:({attrs:c})=>{t=c,c.internals.store.unsubscribe(e)},view:({attrs:c})=>{if(s==null||!s.complete)return c.args.loading;if((s.hasErrors||s.hasMissing)&&typeof c.args.fallback!="function")return c.args.fallback;let f=t.view,{pre:u,sep:g,post:y,start:O,end:S,predicate:R,fallback:E}=t.args;if(typeof f=="undefined")return;let b=[],w=Reflect.ownKeys(r).map(x=>r[x]);(O!=null||S!=null)&&(w=w.slice(O!=null?O:0,S)),R!=null&&(w=w.filter(({octiron:x})=>R(x))),u!=null&&b.push($.fragment({key:bt},[u]));for(let x=0;x<w.length;x++){let{selectionResult:ue,octiron:Pe}=w[x],{key:me}=ue;x!==0&&b.push($.fragment({key:`@${Symbol.keyFor(me)}`},[g])),ue.type==="value"?b.push($.fragment({key:me},[f(Pe)])):!ue.ok&&typeof E=="function"?b.push($.fragment({key:me},[E(Pe,ue.reason)])):ue.ok?b.push($.fragment({key:me},[f(Pe)])):b.push($.fragment({key:me},[E]))}return y!=null&&b.push($.fragment({key:Tt},[y])),b}}};function Be(n){let e=Object.assign((t,s)=>e.root(r=>r(t,s)),{octironType:"root",isOctiron:!0,readonly:!0,value:null,store:n.store,not(t,s){return e.root(r=>r.not(t,s))},root(t,s,r){let o,[i,p,a]=z(t,s,r);return i==null?o=n.store.rootIRI:o=`${n.store.rootIRI} ${i}`,Rt(Q,{selector:o,args:p,view:a,internals:{store:n.store,typeDefs:(p==null?void 0:p.typeDefs)||n.typeDefs}})},select(t,s,r){return e.root(t,s,r)},present(t,s){return e.root(t,s)}});return e}function qe(...n){let e={};for(let t of n)e[t.type]=t;return e}import lt from"mithril";var jt=()=>({view({attrs:{fragment:n,rootHTML:e,fragmentsHTML:t}}){let s=n==null?e:t[n];return s==null?null:lt.trust(s)}}),Ve,xe,M,Ke,N,L,Y,Z,ye,Le=class Le{constructor(e,{iri:t,contentType:s,root:r,ided:o,anon:i}){W(this,"integrationType","html-fragments");m(this,Ve);m(this,xe,new Set);m(this,M);m(this,Ke);m(this,N);m(this,L);m(this,Y);m(this,Z);m(this,ye);d(this,Ve,e),d(this,M,t),d(this,N,s),d(this,L,r),d(this,Y,o!=null?o:{}),d(this,Z,i!=null?i:{}),d(this,ye,k(k({},i),o))}get iri(){return l(this,M)}get contentType(){return l(this,N)}render(e){return lt(jt,{o:e,rootHTML:l(this,L),fragmentsHTML:l(this,ye)})}getStateInfo(){return{iri:l(this,M),contentType:l(this,N),hasRoot:l(this,L)!=null,ided:Object.keys(l(this,Y)),anon:Object.keys(l(this,Z))}}toInitialState(){let e="";l(this,L)!=null&&(e+=`<template id="htmlfrag:${l(this,M)}|${l(this,N)}">${l(this,L)}</template>
`);for(let[t,s]of Object.entries(l(this,Y)))l(this,xe).has(t)||(e+=`<template id="htmlfrag:${l(this,M)}|${l(this,N)}|${t}">${s}</template>
`);for(let[t,s]of Object.entries(l(this,Z)))e+=`<template id="htmlfrag:${l(this,M)}#${t}|${l(this,N)}">${s}</template>
`;return e}static fromInitialState(e,{iri:t,contentType:s,hasRoot:r,ided:o,anon:i}){let p,a={},c={};if(r){let f=document.getElementById(`htmlfrag:${t}|${s}`);f&&(p=f.outerHTML)}for(let f of o){let u=document.getElementById(f);if(u instanceof HTMLTemplateElement){let g=u.cloneNode(!0);a[f]=g.innerHTML}else a[f]=u.innerHTML}for(let f of i){let u=document.getElementById(`htmlfrag:${t}#${f}|${s}`);if(u instanceof HTMLTemplateElement){let g=u.cloneNode(!0);a[f]=g.innerHTML}else a[f]=u.innerHTML}return new Le(e,{contentType:s,iri:t,root:p,ided:a,anon:c})}};Ve=new WeakMap,xe=new WeakMap,M=new WeakMap,Ke=new WeakMap,N=new WeakMap,L=new WeakMap,Y=new WeakMap,Z=new WeakMap,ye=new WeakMap,W(Le,"type","html-fragments");var _=Le;import ct from"mithril";var It=()=>{let n;return{oncreate({dom:e,attrs:{o:t,el:s,handler:r}}){s!=null&&e.append(s),r.onCreate!=null&&(n=r.onCreate({o:t,dom:e,addFragmentListener:()=>{}}))},onbeforeremove(){n!=null&&n()},view({attrs:{html:e,el:t}}){return t!=null?null:ct.trust(e)}}},he,ee,B,q,te,ne,Se,ge=class ge{constructor(e,{iri:t,contentType:s,html:r,id:o,el:i}){W(this,"integrationType","html");m(this,he);m(this,ee,!1);m(this,B);m(this,q);m(this,te);m(this,ne);m(this,Se);d(this,he,e),d(this,B,t),d(this,q,s),d(this,te,r),d(this,ne,o),d(this,Se,i)}get iri(){return l(this,B)}get contentType(){return l(this,q)}render(e){return!F&&!l(this,ee)&&d(this,ee,!0),ct(It,{o:e,html:l(this,te),el:l(this,Se),handler:l(this,he)})}getStateInfo(){return{iri:l(this,B),contentType:l(this,q),id:l(this,ne)}}toInitialState(){return l(this,ne)!=null&&l(this,ee)?"":`<template id="html:${l(this,B)}|${l(this,q)}">${l(this,te)}</template>
`}static fromInitialState(e,{iri:t,contentType:s,id:r}){let o=null;return r!=null&&(o=document.getElementById(r)),o!=null?new ge(e,{iri:t,contentType:s,html:o.outerHTML,id:r,el:o}):(o=document.getElementById(`html:${t}|${s}`),o instanceof HTMLTemplateElement?(o=o.cloneNode(!0),new ge(e,{iri:t,contentType:s,html:o.outerHTML,id:r,el:o})):null)}};he=new WeakMap,ee=new WeakMap,B=new WeakMap,q=new WeakMap,te=new WeakMap,ne=new WeakMap,Se=new WeakMap,W(ge,"type","html");var re=ge;var se,Oe,De=class{constructor(e,t){m(this,se);m(this,Oe);d(this,se,e),d(this,Oe,t)}get status(){return l(this,se)}get res(){return l(this,Oe)}undefined(){return null}http(e){return typeof e=="function"?e(l(this,se)):e}unparserable(){return null}};se=new WeakMap,Oe=new WeakMap;function oe(n){return Array.isArray(n)?n:Array.isArray(n["@list"])?n["@list"]:Array.isArray(n["@set"])?n["@set"]:[]}function J(n){return h(n)&&typeof n["@id"]=="string"&&n["@id"]!==""}function ie(n){if(Array.isArray(n))return!0;if(h(n)){if(Array.isArray(n["@list"]))return!0;if(Array.isArray(n["@set"]))return!0}return!1}function D(n){let e=Object.keys(n);if(e.length===0)return!1;for(let t of e)if(!t.startsWith("@")||t==="@value"||t==="@list"||t==="@set")return!1;return!0}function be(n){return typeof n["@value"]!="undefined"}function le(n,e=[]){if(Array.isArray(n))for(let t of n)le(t,e);else if(h(n)){if(D(n))return e;if(J(n)&&e.push(n),be(n))le(n["@value"],e);else if(ie(n))le(oe(n),e);else for(let[t,s]of Object.entries(n))t.startsWith("@")||le(s,e)}return e}function at(...n){return`${n.map(t=>t.replace(/~/,"~0").replace(/\//,"~1")).join("/")}`}var At=new RegExp("\\s*(?<subject>([^\\[\\s]+))(\\[(?<filter>([^\\]])+)\\])?\\s*","g");function Ge(n){var s,r;let e,t=[];for(;e=At.exec(n);){let o=(s=e.groups)==null?void 0:s.subject,i=(r=e.groups)==null?void 0:r.filter;if(typeof i=="string"&&typeof o=="string")t.push({subject:o,filter:i});else if(typeof o=="string")t.push({subject:o});else throw new Error(`Invalid selector: ${n}`)}return t}var Ue=class extends Error{};function pt(n){for(let e=0;e<n.result.length;e++){let t=n.result[e];t.key=Symbol.for(t.keySource),delete t.keySource}return n}function ve({selector:n,value:e,actionValue:t,store:s}){let r={complete:!1,hasErrors:!1,hasMissing:!1,required:[],dependencies:[],result:[]};if(typeof e=="undefined"){let[{subject:i,filter:p},...a]=Ge(n);return we({keySource:"",pointer:"",iri:i,filter:p,selector:a.length>0?a:void 0,store:s,details:r}),r.complete=r.required.length===0,pt(r)}let o=Ge(n);Te({keySource:"",pointer:"",value:e,actionValue:t,selector:o,store:s,details:r}),r.complete=r.required.length===0;for(let i=0;i<r.result.length;i++){let p=r.result[i];p.key=Symbol.for(p.keySource)}return pt(r)}function j(n,e){return`${n}/${at(e.toString())}`}function ze({value:n,filter:e}){return typeof e!="string"?!0:Array.isArray(n["@type"])?n["@type"].includes(e):n["@type"]===e}function Qe(n){return n!==null&&typeof n!="undefined"&&typeof n!="boolean"&&typeof n!="number"&&typeof n!="string"}function We({keySource:n,pointer:e,value:t,datatype:s,filter:r,store:o,details:i}){if(t==null){i.hasMissing=!0;return}if(Qe(t)){if(ie(t)){let p=oe(t);for(let a=0;a<p.length;a++){let c=p[a];if(J(c)||(n=j(n,a)),We({keySource:n,pointer:j(e,a),value:c,datatype:s,filter:r,store:o,details:i}),i.hasErrors||i.hasMissing)return}return}}else{i.result.push({keySource:e,pointer:e,type:"value",datatype:s,value:t});return}if(!(typeof r=="string"&&!ze({value:t,filter:r}))){if(be(t)){We({keySource:n,pointer:e,value:t["@value"],datatype:s,store:o,details:i});return}else if(D(t)){we({keySource:n,pointer:e,iri:t["@id"],filter:r,store:o,details:i});return}if(J(t)){let p=t["@id"];i.result.push({keySource:n,pointer:e,type:"entity",iri:p,ok:!0,value:t});return}i.result.push({keySource:n,pointer:e,type:"value",datatype:s,value:t})}}function ft({keySource:n,pointer:e,type:t,value:s,actionValue:r,filter:o,store:i,details:p}){if(e=j(e,t),!Qe(s))return;if(ie(s)){let c=oe(s);for(let f=0;f<c.length;f++){let u=c[f];if(J(u)||(n=j(n,f)),ft({keySource:n,pointer:j(e,f),type:t,value:u,actionValue:r,filter:o,store:i,details:p}),p.hasErrors||p.hasMissing)return}return}if(D(s)&&J(s)){we({keySource:n,pointer:e,iri:s["@id"],selector:[{subject:t,filter:o}],store:i,details:p});return}else if(D(s))return;let a;h(r==null?void 0:r[`${t}-input`])&&(a=r[`${t}-input`]),We({keySource:n,pointer:e,value:s[t],spec:a,actionValue:r==null?void 0:r[t],datatype:t,filter:o,store:i,details:p})}function Te({keySource:n,pointer:e,selector:t,value:s,actionValue:r,store:o,details:i}){if(t.length===0)return;if(!Qe(s))return;if(ie(s)){let g=oe(s);for(let y=0;y<g.length;y++){let O=g[y];if(J(O)||(n=j(n,y)),Te({keySource:n,pointer:j(e,y),selector:t,value:O,actionValue:r,store:o,details:i}),i.hasErrors||i.hasMissing)return}return}else be(s)&&Te({keySource:n,pointer:e,selector:t,value:s["@value"],actionValue:r,store:o,details:i});if(D(s)&&J(s)){we({keySource:n,pointer:e,selector:t,iri:s["@id"],store:o,details:i});return}h(s)&&r!==void 0&&s[t[0].subject]==null&&(s={[t[0].subject]:null});let[p,...a]=t,{subject:c,filter:f}=p;if(s[c]==null){i.hasMissing=!0;return}if(a.length===0){ft({keySource:n,pointer:e,type:c,filter:f,value:s,actionValue:r,store:o,details:i});return}if(typeof f=="string"&&!ze({value:s,filter:f}))return;let u;h(r==null?void 0:r[c])&&(u=r[c]),Te({keySource:j(n,c),pointer:j(e,c),selector:a,value:s[c],actionValue:u,store:o,details:i})}function we({keySource:n,pointer:e,iri:t,filter:s,selector:r,store:o,details:i,handledIRIs:p}){n=j(n,t),e=j(e,t);let a=o.entity(t);if(i.dependencies.push(t),typeof a=="undefined"||a.loading){i.required.includes(t)||i.required.push(t);return}if(!a.ok){if(i.hasErrors=!0,typeof r=="undefined"||r.length===0)return;i.result.push({keySource:n,pointer:e,type:"entity",iri:a.iri,ok:!1,status:a.status,value:a.value,reason:a.reason});return}let c=a.value;if(D(c)){if(p==null)p=new Set([c["@id"]]);else if(!p.has(c["@id"]))p.add(c["@id"]);else throw new Ue("Circular selection loop detected");return we({keySource:n,pointer:e,iri:c["@id"],filter:s,selector:r,details:i,store:o,handledIRIs:p})}if(!(typeof s=="string"&&!ze({filter:s,value:c}))){if(typeof r=="undefined"){i.result.push({keySource:n,pointer:e,type:"entity",iri:a.iri,ok:!0,value:a.value});return}Te({keySource:n,pointer:e,value:c,selector:r,store:o,details:i})}}var K="application/problem+json, application/ld+json, text/lf",Ht={[re.type]:re,[_.type]:_};function Ct(n,e){let t=new Map,s={};if(n!=null&&(s["@vocab"]=n),e==null)return[t,s];for(let[r,o]of Object.entries(e))s[r]=o,t.set(`^${r}:`,o);return[t,s]}function Mt(n,e){let t=new Headers([["accept",K]]),s=new Map;if(n!=null)for(let[r,o]of Object.entries(n))t.set(r,o);if(e!=null)for(let[r,o]of Object.entries(e)){let i=new Headers([["accept",K]]);for(let[p,a]of Object.entries(o))i.set(p,a);s.set(r,i)}return[t,s]}var ce,je,V,G,v,ae,I,pe,P,Ie,Ae,He,Ce,Me,fe,H,U,T,Xe,Ye,Ze,ut,mt,_e=class _e{constructor(e){m(this,T);m(this,ce);m(this,je);m(this,V);m(this,G);m(this,v);m(this,ae);m(this,I,new Map);m(this,pe,new Set);m(this,P,new Map);m(this,Ie);m(this,Ae,new Set);m(this,He);m(this,Ce,new Map);m(this,Me);m(this,fe);m(this,H,new Map);m(this,U,new Map);var t,s,r;d(this,ce,e.rootIRI),d(this,je,new URL(e.rootIRI).origin),d(this,v,e.vocab),d(this,Me,(t=e.fetcher)!=null?t:fetch),d(this,fe,e.responseHook),[de(this,V)._,de(this,G)._]=Mt(e.headers,e.origins),[de(this,ae)._,de(this,He)._]=Ct(e.vocab,e.aliases),d(this,Ie,new Map((r=(s=e.handlers)==null?void 0:s.map)==null?void 0:r.call(s,o=>[o.contentType,o]))),e.primary!=null&&d(this,I,new Map(Object.entries(e.primary))),l(this,V).has("accept")||l(this,V).set("accept",K);for(let o of Object.values(l(this,G)))o.has("accept")||o.set("accept",K)}get rootIRI(){return l(this,ce)}entity(e){return l(this,I).get(e)}get context(){return l(this,He)}expand(e){let t=Symbol.for(e),s=l(this,Ce).get(t);if(s!=null)return s;let r;if(l(this,v)!=null&&e.startsWith(l(this,v)))r=e.replace(l(this,v),"");else if(/https?:\/\//.test(e))r=e;else for(let[o,i]of l(this,ae)){let p=new RegExp(o);if(p.test(e)){r=e.replace(p,i);break}}return l(this,Ce).set(t,r!=null?r:e),r!=null?r:e}select(e,t){return ve({selector:e,value:t,store:this})}key(){if(F)return"";for(;;){let e=Math.random().toString(36).slice(2,7);if(!l(this,Ae).has(e))return l(this,Ae).add(e),e}}isLoading(e){let t=C(this,T,Ye).call(this,e,"get");return l(this,pe).has(t)}handleResponse(s){return A(this,arguments,function*(e,t=e.url.toString()){var i,p,a;let r=(a=(p=(i=e.headers.get("content-type"))==null?void 0:i.split)==null?void 0:p.call(i,";"))==null?void 0:a[0];if(r==null)throw new Error("Content type not specified in response");let o=l(this,Ie).get(r);if(o==null)throw new Error(`No handler configured for content type "${r}"`);if(o.integrationType==="jsonld"){let c=yield o.handler({res:e,store:this});C(this,T,ut).call(this,{iri:t,res:e,output:c})}else{if(o.integrationType==="problem-details")throw new Error("Problem details response types not supported yet");if(o.integrationType==="html"){let c=yield o.handler({res:e,store:this}),f=l(this,P).get(r);f==null&&(f=new Map,l(this,P).set(r,f)),f.set(t,new re(o,{iri:t,contentType:r,html:c.html,id:c.id}))}else if(o.integrationType==="html-fragments"){let c=yield o.handler({res:e,store:this}),f=l(this,P).get(r);f==null&&(f=new Map,l(this,P).set(r,f)),f.set(t,new _(o,{iri:t,contentType:r,root:c.html,ided:c.ided,anon:c.anon}))}}o.integrationType!=="jsonld"&&C(this,T,Ze).call(this,t,r)})}subscribe({key:e,selector:t,value:s,listener:r}){let o=ve({selector:t,value:s,store:this}),i=C(this,T,Xe).call(this,e,o);for(let p of o.dependencies){let a=l(this,H).get(p);a==null?l(this,H).set(p,new Set([e])):a.add(e)}return l(this,U).set(e,{key:e,selector:t,value:s,required:o.required,dependencies:o.dependencies,listener:r,cleanup:i}),o}unsubscribe(e){var t;(t=l(this,U).get(e))==null||t.cleanup()}fetch(e){return A(this,null,function*(){return yield C(this,T,mt).call(this,e),l(this,I).get(e)})}static fromInitialState({headers:e,origins:t,handlers:s=[]}){let r=document.getElementById("oct-state-info"),o=JSON.parse(r.innerText),i=new Map,p=s.reduce((a,c)=>rt(k({},a),{[c.contentType]:c}),{});for(let[a,c]of Object.entries(o.alternatives))for(let f of c){let u=p[f.contentType],g=Ht[a];if(g.type!==u.integrationType)continue;let y=g.fromInitialState(u,f);if(y==null)continue;let O=i.get(y.contentType);O==null&&(O=new Map,i.set(y.contentType,O)),O.set(y.iri,y)}return new _e({handlers:s,alternatives:i,headers:e,origins:t,rootIRI:o.rootIRI,vocab:o.vocab,aliases:o.aliases,primary:o.primary})}toInitialState(){let e="",t={rootIRI:l(this,ce),vocab:l(this,v),aliases:Object.fromEntries(l(this,ae)),primary:Object.fromEntries(l(this,I)),alternatives:{}};for(let s of l(this,P).values())for(let r of s.values())t.alternatives[r.integrationType]==null?t.alternatives[r.integrationType]=[r.getStateInfo()]:t.alternatives[r.integrationType].push(r.getStateInfo()),e+=r.toInitialState();return e+=`<script id="oct-state-info" type="application/json">${JSON.stringify(t)}<\/script>`,e}};ce=new WeakMap,je=new WeakMap,V=new WeakMap,G=new WeakMap,v=new WeakMap,ae=new WeakMap,I=new WeakMap,pe=new WeakMap,P=new WeakMap,Ie=new WeakMap,Ae=new WeakMap,He=new WeakMap,Ce=new WeakMap,Me=new WeakMap,fe=new WeakMap,H=new WeakMap,U=new WeakMap,T=new WeakSet,Xe=function(e,t){return()=>{l(this,U).delete(e);for(let s of t.dependencies)l(this,H).delete(s),F&&setTimeout(()=>{var r;((r=l(this,H).get(s))==null?void 0:r.size)===0&&l(this,I).delete(s)},5e3)}},Ye=function(e,t,s){return s=s||l(this,V).get("accept")||K,`${t==null?void 0:t.toLowerCase()}|${e}|${s.toLowerCase()}`},Ze=function(e,t){let s=l(this,H).get(e);if(s!=null)for(let r of s){let o=l(this,U).get(r);if(o==null)continue;let i=ve({selector:o.selector,value:o.value,store:this}),p=C(this,T,Xe).call(this,r,i);for(let a of i.dependencies){let c=l(this,H).get(a);c==null?(c=new Set([r]),l(this,H).set(a,c)):c.add(r)}o.cleanup=p,o.listener(i)}},ut=function({iri:e,res:t,output:s}){let r=[e];if(t.ok)l(this,I).set(e,{iri:e,loading:!1,ok:!0,value:s.jsonld});else{let o=new De(t.status,t);l(this,I).set(e,{iri:e,loading:!1,ok:!1,value:s.jsonld,status:t.status,reason:o})}for(let o of le(s.jsonld))r.includes(o["@id"])||l(this,I).set(o["@id"],{iri:o["@id"],loading:!1,ok:!0,value:o});for(let o in r)C(this,T,Ze).call(this,o)},mt=function(s){return A(this,arguments,function*(e,t={}){let r,o=new URL(e),i=t.method||"get",p=t.accept||l(this,V).get("accept")||K,a=C(this,T,Ye).call(this,e,i,t.accept);if(o.origin===l(this,je))r=new Headers(l(this,V));else if(l(this,G).has(o.origin))r=new Headers(l(this,G).get(o.origin));else throw new Error("Unconfigured origin");p!=null?r.set("accept",p):r.get("accept")==null&&r.set("accept",K),l(this,pe).add(a),X();let c=new Promise(f=>{A(this,null,function*(){let u=yield l(this,Me).call(this,e,{method:i,headers:r,body:t.body});yield this.handleResponse(u,e),l(this,pe).delete(a),X(),f(u)})});l(this,fe)!=null&&l(this,fe).call(this,c),yield c})};var Re=_e;function Xn(n){return n}import dt from"jsonld";var er={integrationType:"jsonld",contentType:"application/ld+json",handler:t=>A(null,[t],function*({res:n,store:e}){let s=yield n.json();if(!h(s)&&!Array.isArray(s))throw new Error("JSON-LD Document should be an object");let r=yield dt.expand(s,{documentLoader:i=>A(null,null,function*(){let a=yield(yield fetch(i,{headers:{accept:"application/ld+json"}})).json();return{documentUrl:i,document:a}})});return{jsonld:yield dt.compact(r,e.context)}})};function yt(t){var s=t,{typeDefs:n}=s,e=ke(s,["typeDefs"]);let r=n!=null?qe(...n):{},o=new Re(e);return Be({store:o,typeDefs:r})}yt.fromInitialState=t=>{var s=t,{typeDefs:n}=s,e=ke(s,["typeDefs"]);let r=n!=null?qe(...n):{},o=Re.fromInitialState(k({},e));return Be({store:o,typeDefs:r})};export{Re as Store,yt as default,er as jsonLDHandler,Xn as makeTypeDef,qe as makeTypeDefs};
