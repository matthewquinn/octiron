var Oe=Object.getOwnPropertySymbols;var Pe=Object.prototype.hasOwnProperty,De=Object.prototype.propertyIsEnumerable;var ge=e=>{throw TypeError(e)};var ee=(e,r)=>{var t={};for(var n in e)Pe.call(e,n)&&r.indexOf(n)<0&&(t[n]=e[n]);if(e!=null&&Oe)for(var n of Oe(e))r.indexOf(n)<0&&De.call(e,n)&&(t[n]=e[n]);return t};var be=(e,r,t)=>r.has(e)||ge("Cannot "+t);var M=(e,r,t)=>(be(e,r,"read from private field"),t?t.call(e):r.get(e)),te=(e,r,t)=>r.has(e)?ge("Cannot add the same private member more than once"):r instanceof WeakSet?r.add(e):r.set(e,t),re=(e,r,t,n)=>(be(e,r,"write to private field"),n?n.call(e,t):r.set(e,t),t);var C=(e,r,t)=>new Promise((n,s)=>{var p=l=>{try{c(t.next(l))}catch(i){s(i)}},o=l=>{try{c(t.throw(l))}catch(i){s(i)}},c=l=>l.done?n(l.value):Promise.resolve(l.value).then(p,o);c((t=t.apply(e,r)).next())});import Fe from"mithril";import E from"mithril";import ne from"mithril";function he({style:e,datatype:r,type:t,firstPickComponent:n,typeDefs:s,fallbackComponent:p}){var o,c,l;if(typeof n!="undefined")return n;if(typeof r!="undefined"&&typeof((o=s[r])==null?void 0:o[e])!="undefined")return s[r][e];if(typeof t=="string"&&typeof((c=s[t])==null?void 0:c[e])!="undefined")return s[t][e];if(Array.isArray(t)){for(let i of t)if(typeof((l=s[i])==null?void 0:l[e])!="undefined")return s[i][e]}if(typeof p!="undefined")return p}function $(e,r,t){let n,s={},p;return typeof e=="string"?n=e:typeof e=="function"?p=e:e!=null&&(s=e),typeof r=="function"?p=r:r!=null&&(s=r),typeof t=="function"&&(p=t),p==null&&(p=o=>o.present(s)),[n,s,p]}function S(e){return typeof e=="object"&&!Array.isArray(e)&&e!==null}function je(e){if(S(e)){if(typeof e["@type"]=="string")return!0;if(!Array.isArray(e["@type"]))return!1}else return!1;for(let r of e["@type"])if(typeof r!="string")return!1;return!0}function we(e){if(je(e))return e["@type"]}function ce(e,r){let t=Object.assign({},r),n=we(e.value),s={isOctiron:!0,octironType:"selection",value:e.value},p=Object.assign((o,c)=>e.parent==null?null:o(e.parent)?c:null,{isOctiron:!0,octironType:"selection",readonly:!0,id:e.datatype,get value(){return s.value},get store(){return e.store},not:(o,c)=>e.parent==null||o(e.parent)?null:c,root:(o,c,l)=>{let i,[u,y,h]=$(o,c,l);return u==null?i=e.store.rootIRI:i=`${e.store.rootIRI} ${u}`,ne(q,{selector:i,args:y,view:h,internals:{store:e.store,typeDefs:e.typeDefs}})},enter(o,c,l){let[i,u,y]=$(o,c,l);return ne(q,{selector:i,args:u,view:y,internals:{store:e.store,typeDefs:e.typeDefs}})},select:(o,c,l)=>{let[i,u,y]=$(o,c,l);return S(e.value)?ne(q,{selector:i,args:u,view:y,internals:{store:e.store,typeDefs:e.typeDefs,value:e.value}}):null},present(o){var b;let c={},l,i;(o==null?void 0:o.attrs)!=null?c=o.attrs:(t==null?void 0:t.attrs)!=null&&(c=t.attrs),(o==null?void 0:o.component)!=null?l=o.component:(t==null?void 0:t.component)!=null&&(l=t.component),(o==null?void 0:o.fallbackComponent)!=null?i=o.fallbackComponent:(t==null?void 0:t.fallbackComponent)!=null&&(i=t.fallbackComponent);let u=he({style:"present",datatype:e.datatype,type:n,firstPickComponent:l,fallbackComponent:i,typeDefs:(b=e.typeDefs)!=null?b:{}});if(u==null)return null;let{pre:y,sep:h,post:d,start:a,end:O,predicate:j}=Object.assign({},t,o);return ne(u,{o:p,renderType:"present",value:p.value,attrs:c,pre:y,sep:h,post:d,start:a,end:O,predicate:j})},_updateArgs:o=>{for(let[c,l]of Object.entries(o))t[c]=l},_updateValue:o=>{s.value=o}});return p}import ke from"mithril";var oe=typeof window!="undefined";function pe(){oe&&ke.redraw()}function Ie(e,r){return e.internals.store!==r.internals.store||e.selector!==r.selector||e.internals.value!==r.internals.value}var q=e=>{let r=Symbol("SelectionRenderer"),t=e.attrs,n,s={};function p(){let i=!1,{store:u,typeDefs:y}=t.internals,h=[];if(n==null){let a=Reflect.ownKeys(s);for(let O of a)h.includes(O)||(i=!0,delete s[O]);i&&pe();return}for(let a of n.result){if(h.push(a.key),Object.hasOwn(s,a.key)){let j=a,b=s[a.key].selectionResult;if(b.type==="value"&&j.type==="value"&&j.value===b.value)continue;if(b.type==="entity"&&j.type==="entity"&&(j.ok!==b.ok||j.status!==b.status||j.value!==b.value))continue}i=!0;let O;a.type==="entity"?O=ce({store:u,typeDefs:y,value:a.value}):O=ce({store:u,typeDefs:y,value:a.value,datatype:a.datatype}),s[a.key]={octiron:O,selectionResult:a}}let d=Reflect.ownKeys(s);for(let a of d)h.includes(a)||(i=!0,delete s[a]);i&&pe()}function o(i){return C(this,null,function*(){if(i.length===0)return;let u=[];for(let y of i)u.push(t.internals.store.fetch(y));yield Promise.allSettled(u)})}function c(i){let u=[];if(typeof n=="undefined")u=i.required;else for(let y of i.required)n.required.includes(y)||u.push(y);n=i,u.length>0&&o(u),p()}function l(){if(typeof t.internals.value!="undefined"&&!S(t.internals.value)){t.internals.store.unsubscribe(r),p();return}n=t.internals.store.subscribe({key:r,selector:t.selector,value:t.internals.value,listener:c}),o(n.required),p()}return{oninit:({attrs:i})=>{t=i,l()},onbeforeupdate:({attrs:i})=>{let u=Ie(i,t);t=i,u&&(i.internals.store.unsubscribe(r),l())},onbeforeremove:({attrs:i})=>{t=i,i.internals.store.unsubscribe(r)},view:({attrs:i})=>{if(n==null||!n.complete)return i.args.loading;if((n.hasErrors||n.hasMissing)&&typeof i.args.fallback!="function")return i.args.fallback;let u=t.view,{pre:y,sep:h,post:d,start:a,end:O,predicate:j,fallback:b}=t.args;if(typeof u=="undefined")return;let T=[],x=Reflect.ownKeys(s).map(R=>s[R]);(a!=null||O!=null)&&(x=x.slice(a!=null?a:0,O)),j!=null&&(x=x.filter(({octiron:R})=>j(R))),y!=null&&T.push(E.fragment({key:ve},[y]));for(let R=0;R<x.length;R++){let{selectionResult:D,octiron:F}=x[R],{key:k}=D;R!==0&&T.push(E.fragment({key:`@${Symbol.keyFor(k)}`},[h])),D.type==="value"?T.push(E.fragment({key:k},[u(F)])):!D.ok&&typeof b=="function"?T.push(E.fragment({key:k},[b(F,D.reason)])):D.ok?T.push(E.fragment({key:k},[u(F)])):T.push(E.fragment({key:k},[b]))}return d!=null&&T.push(E.fragment({key:Ee},[d])),T}}},ve=Symbol.for("@pre"),Ee=Symbol.for("@post");function Re(e){let r=Object.assign((t,n)=>r.root(s=>s(t,n)),{octironType:"root",isOctiron:!0,readonly:!0,value:null,store:e.store,not(t,n){return r.root(s=>s.not(t,n))},root(t,n,s){let p,[o,c,l]=$(t,n,s);return o==null?p=e.store.rootIRI:p=`${e.store.rootIRI} ${o}`,Fe(q,{selector:p,args:c,view:l,internals:{store:e.store,typeDefs:e.typeDefs}})},select(t,n,s){return r.root(t,n,s)},present(t,n){return r.root(t,n)}});return r}function B(e){return Array.isArray(e)?e:Array.isArray(e["@list"])?e["@list"]:Array.isArray(e["@set"])?e["@set"]:[]}function P(e){return S(e)&&typeof e["@id"]=="string"&&e["@id"]!==""}function L(e){if(Array.isArray(e))return!0;if(S(e)){if(Array.isArray(e["@list"]))return!0;if(Array.isArray(e["@set"]))return!0}return!1}function v(e){let r=Object.keys(e);if(r.length===0)return!1;for(let t of r)if(!t.startsWith("@")||t==="@value"||t==="@list"||t==="@set")return!1;return!0}function Q(e){return typeof e["@value"]!="undefined"}function K(e,r=[]){if(Array.isArray(e))for(let t of e)K(t,r);else if(S(e)){if(v(e))return r;if(P(e)&&r.push(e),Q(e))K(e["@value"],r);else if(L(e))K(B(e),r);else for(let[t,n]of Object.entries(e))t.startsWith("@")||K(n,r)}return r}function Ae(...e){return`${e.map(t=>t.replace(/~/,"~0").replace(/\//,"~1")).join("/")}`}var He=new RegExp("\\s*(?<subject>([^\\[\\s]+))(\\[(?<filter>([^\\]])+)\\])?\\s*","g");function ue(e){var n,s;let r,t=[];for(;r=He.exec(e);){let p=(n=r.groups)==null?void 0:n.subject,o=(s=r.groups)==null?void 0:s.filter;if(typeof o=="string"&&typeof p=="string")t.push({subject:p,filter:o});else if(typeof p=="string")t.push({subject:p});else throw new Error(`Invalid selector: ${e}`)}return t}var fe=class extends Error{};function Ne(e){for(let r=0;r<e.result.length;r++){let t=e.result[r];t.key=Symbol.for(t.keySource),delete t.keySource}return e}function se({selector:e,value:r,actionValue:t,store:n}){let s={complete:!1,hasErrors:!1,hasMissing:!1,required:[],dependencies:[],result:[]};if(typeof r=="undefined"){let[{subject:o,filter:c},...l]=ue(e);return Y({keySource:"",pointer:"",iri:o,filter:c,selector:l.length>0?l:void 0,store:n,details:s}),s.complete=s.required.length===0,Ne(s)}let p=ue(e);X({keySource:"",pointer:"",value:r,actionValue:t,selector:p,store:n,details:s}),s.complete=s.required.length===0;for(let o=0;o<s.result.length;o++){let c=s.result[o];c.key=Symbol.for(c.keySource)}return Ne(s)}function V(e,r){return`${e}/${Ae(r.toString())}`}function ye({value:e,filter:r}){return typeof r!="string"?!0:Array.isArray(e["@type"])?e["@type"].includes(r):e["@type"]===r}function de(e){return e!==null&&typeof e!="undefined"&&typeof e!="boolean"&&typeof e!="number"&&typeof e!="string"}function ae({keySource:e,pointer:r,value:t,datatype:n,filter:s,store:p,details:o}){if(t==null){o.hasMissing=!0;return}if(de(t)){if(L(t)){let c=B(t);for(let l=0;l<c.length;l++){let i=c[l];if(P(i)||(e=V(e,l)),ae({keySource:e,pointer:V(r,l),value:i,datatype:n,filter:s,store:p,details:o}),o.hasErrors||o.hasMissing)return}return}}else{o.result.push({keySource:r,pointer:r,type:"value",datatype:n,value:t});return}if(!(typeof s=="string"&&!ye({value:t,filter:s}))){if(Q(t)){ae({keySource:e,pointer:r,value:t["@value"],datatype:n,store:p,details:o});return}else if(v(t)){Y({keySource:e,pointer:r,iri:t["@id"],filter:s,store:p,details:o});return}if(P(t)){let c=t["@id"],l=p.entities[c].contentType;o.result.push({keySource:e,pointer:r,type:"entity",iri:c,ok:!0,value:t,contentType:l});return}o.result.push({keySource:e,pointer:r,type:"value",datatype:n,value:t})}}function Je({keySource:e,pointer:r,type:t,value:n,actionValue:s,filter:p,store:o,details:c}){if(r=V(r,t),!de(n))return;if(L(n)){let i=B(n);for(let u=0;u<i.length;u++){let y=i[u];if(P(y)||(e=V(e,u)),Je({keySource:e,pointer:V(r,u),type:t,value:y,actionValue:s,filter:p,store:o,details:c}),c.hasErrors||c.hasMissing)return}return}if(v(n)&&P(n)){Y({keySource:e,pointer:r,iri:n["@id"],selector:[{subject:t,filter:p}],store:o,details:c});return}else if(v(n))return;let l;S(s==null?void 0:s[`${t}-input`])&&(l=s[`${t}-input`]),ae({keySource:e,pointer:r,value:n[t],spec:l,actionValue:s==null?void 0:s[t],datatype:t,filter:p,store:o,details:c})}function X({keySource:e,pointer:r,selector:t,value:n,actionValue:s,store:p,details:o}){if(t.length===0)return;if(!de(n))return;if(L(n)){let h=B(n);for(let d=0;d<h.length;d++){let a=h[d];if(P(a)||(e=V(e,d)),X({keySource:e,pointer:V(r,d),selector:t,value:a,actionValue:s,store:p,details:o}),o.hasErrors||o.hasMissing)return}return}else Q(n)&&X({keySource:e,pointer:r,selector:t,value:n["@value"],actionValue:s,store:p,details:o});if(v(n)&&P(n)){Y({keySource:e,pointer:r,selector:t,iri:n["@id"],store:p,details:o});return}S(n)&&s!==void 0&&n[t[0].subject]==null&&(n={[t[0].subject]:null});let[c,...l]=t,{subject:i,filter:u}=c;if(n[i]==null){o.hasMissing=!0;return}if(l.length===0){Je({keySource:e,pointer:r,type:i,filter:u,value:n,actionValue:s,store:p,details:o});return}if(typeof u=="string"&&!ye({value:n,filter:u}))return;let y;S(s==null?void 0:s[i])&&(y=s[i]),X({keySource:V(e,i),pointer:V(r,i),selector:l,value:n[i],actionValue:y,store:p,details:o})}function Y({keySource:e,pointer:r,iri:t,filter:n,selector:s,store:p,details:o,handledIRIs:c}){e=V(e,t),r=V(r,t);let l=p.entities[t];if(o.dependencies.push(t),typeof l=="undefined"||l.loading){o.required.includes(t)||o.required.push(t);return}if(!l.ok){if(o.hasErrors=!0,typeof s=="undefined"||s.length===0)return;o.result.push({keySource:e,pointer:r,type:"entity",iri:l.iri,ok:!1,status:l.status,value:l.value,contentType:l.contentType,reason:l.reason});return}let i=l.value;if(v(i)){if(c==null)c=new Set([i["@id"]]);else if(!c.has(i["@id"]))c.add(i["@id"]);else throw new fe("Circular selection loop detected");return Y({keySource:e,pointer:r,iri:i["@id"],filter:n,selector:s,details:o,store:p,handledIRIs:c})}if(!(typeof n=="string"&&!ye({filter:n,value:i}))){if(typeof s=="undefined"){o.result.push({keySource:e,pointer:r,type:"entity",iri:l.iri,ok:!0,value:l.value,contentType:l.contentType});return}X({keySource:e,pointer:r,value:i,selector:s,store:p,details:o})}}import Ve from"jsonld";var Te=t=>C(null,[t],function*({res:e,store:r}){let n=yield e.json();if(!S(n)&&!Array.isArray(n))throw new Error("JSON-LD Document should be an object");let s=yield Ve.expand(n,{documentLoader:o=>C(null,null,function*(){let l=yield(yield fetch(o,{headers:{accept:"application/ld+json"}})).json();return{documentUrl:o,document:l}})});return{value:yield Ve.compact(s,r.context),outputType:"jsonld"}});var _,Z,ie=class{constructor(r,t){te(this,_);te(this,Z);re(this,_,r),re(this,Z,t)}get status(){return M(this,_)}get res(){return M(this,Z)}undefined(){return null}http(r){return typeof r=="function"?r(M(this,_)):r}unparserable(){return null}};_=new WeakMap,Z=new WeakMap;var U,le=class{constructor(r){te(this,U);re(this,U,r)}get error(){return M(this,U)}undefined(){return null}http(){return null}unparserable(r){return typeof r=="function"?r(M(this,U)):r}};U=new WeakMap;function xe(s){var p=s,{rootIRI:e,vocab:r,responseHook:t}=p,n=ee(p,["rootIRI","vocab","responseHook"]);var x,R,D,F,k;let o={},c=(x=n.headers)!=null?x:{},l=(R=n.handlers)!=null?R:{},i=new Map([[e,c],...Object.entries(Object.assign({},n.origins))]),u=(D=n.entities)!=null?D:{},y=(F=n.aliases)!=null?F:{},h=(k=n.fetcher)!=null?k:fetch;if(typeof r=="string"&&(o["@vocab"]=r),typeof n.aliases!="undefined")for(let[f,m]of Object.entries(n.aliases))o[f]=m;let d={rootIRI:e,vocab:r,aliases:y,entities:u,context:o};l["application/ld+json"]==null&&(l["application/ld+json"]=Te);let a={},O={};function j({key:f,details:m}){return function(){delete O[f];for(let N of m.dependencies){if(typeof a[N]=="undefined")continue;let w=a[N].indexOf(f);a[N].splice(w,1),oe&&a[N].length===0&&delete u[N]}}}function b(f){let m=[...a[f]||[]];for(let A of m){let{selector:N,value:w,listener:W}=O[A],g=se({selector:N,value:w,store:d}),J=j({key:A,details:g});for(let H of g.dependencies)Array.isArray(a[H])?a[H].push(A):a[H]=[A];O[A].cleanup=J,W(g)}}function T(A){return C(this,arguments,function*(f,m={}){let N=new URL(f);if(!i.has(N.origin))throw new Error("Unconfigured origin");if(u[f])return;u[f]={iri:f,loading:!0};let w=new Promise(W=>{setTimeout(()=>C(null,null,function*(){var H,me;let g=yield h(f,{method:(H=m.method)!=null?H:"get",headers:Object.assign({},i.get(f),m.headers),body:m.body}),J=(me=g.headers.get("content-type"))==null?void 0:me.split(";")[0];if(J==null)throw new Error("No content type");if(J===null||l[J]===null){let z=new Error(`Unsupported content type ${J}`),G=new le(z);u[f]={iri:f,loading:!1,ok:!1,value:{},status:g.status,contentType:J,reason:G};return}try{let{outputType:z,value:G}=yield l[J]({res:g,store:d}),Se=[f];if(g.ok)u[f]={iri:f,loading:!1,ok:!0,value:G,contentType:J};else{let I=new ie(g.status,g);u[f]={iri:f,loading:!1,ok:!1,value:G,status:g.status,contentType:J,reason:I}}if(z==="jsonld")for(let I of K(G))Se.includes(I["@id"])||(u[I["@id"]]={iri:I["@id"],loading:!1,ok:!0,value:I,contentType:J});for(let I of Se)b(I)}catch(z){console.error(z)}W(g)}))});typeof t=="function"&&t(w),yield w})}d.fetch=function(f){return C(this,null,function*(){return yield T(f),u[f]})},d.expand=function(f){if(f.includes(":")){let[m,A]=f.split(":");return`${y[m]}${A}`}else if(typeof r!="string")return f;return`${r}${f}`},d.select=(f,m)=>se({selector:f,value:m,store:d}),d.subscribe=function({key:f,selector:m,value:A,listener:N}){let w=se({selector:m,value:A,store:d}),W=j({key:f,details:w});for(let g of w.dependencies)Array.isArray(a[g])?a[g].push(f):a[g]=[f];return O[f]={key:f,selector:m,value:A,required:w.required,dependencies:w.dependencies,listener:N,cleanup:W},w},d.unsubscribe=function(f){var m;(m=O[f])==null||m.cleanup()},typeof r=="string"&&(o["@vocab"]=r);for(let[f,m]of Object.entries(y))o[f]=m;return c.accept==null&&(c.accept="application/ld+json"),d}function Ce(...e){let r={};for(let t of e)r[t.type]=t;return r}function er(e){return e}function Me(t){var n=t,{typeDefs:e}=n,r=ee(n,["typeDefs"]);let s=e!=null?Ce(...e):{},p=xe(r);return Re({store:p,typeDefs:s})}export{Me as default,xe as makeStore,er as makeTypeDef,Ce as makeTypeDefs};
